<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AraShift System v8.2 (Smart Print)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Ô£ø SYSTEM VARIABLES --- */
        :root {
            --primary: #007AFF; --primary-dim: #E5F0FF;
            --success: #34C759; --success-dim: #E2F9E8;
            --danger: #FF3B30; --danger-dim: #FFEAEA;
            --warning: #FF9500; --warning-dim: #FFF5E5;
            --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1D1D1F; --text-sec: #86868B;
            --border: #E5E5EA;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 1100px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* NAVIGATION TABS */
        .nav-tabs { display: flex; gap: 12px; margin-bottom: 25px; padding: 5px; background: #E5E5EA; border-radius: 12px; width: fit-content; }
        .tab-btn { background: transparent; border: none; font-size: 14px; font-weight: 600; color: var(--text-sec); cursor: pointer; padding: 10px 20px; border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-btn:hover { color: var(--text); }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .brand { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: baseline; gap: 8px; } 
        .brand span { color: var(--primary); }
        .version-tag { font-size: 11px; color: var(--text-sec); font-weight: 700; background: #E5E5EA; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .logout { color: var(--primary); cursor: pointer; font-weight: 500; font-size: 14px; }

        /* CARDS & PANELS */
        .card { background: var(--card-bg); border-radius: 18px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); margin-bottom: 20px; }
        .card h3 { font-size: 13px; text-transform: uppercase; color: var(--text-sec); margin: 0 0 15px 0; letter-spacing: 0.05em; font-weight: 800; }
        
        /* PARAMETER PANELS (NEW DESIGN) */
        .param-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .param-panel { 
            background: #F9FAFB; border: 1px solid #E5E5EA; border-radius: 10px; padding: 10px 12px; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .param-panel label { margin: 0 0 4px 0; font-size: 10px; text-transform: uppercase; color: var(--text-sec); display: flex; justify-content: space-between; }
        .param-panel input { 
            background: transparent; border: none; padding: 0; font-size: 15px; font-weight: 700; color: var(--text); width: 100%; outline: none; 
        }
        .param-panel input:focus { border-bottom: 2px solid var(--primary); border-radius: 0; }
        .param-panel.warning { background: var(--warning-dim); border-color: var(--warning); }
        .param-panel.abnormal { background: var(--danger-dim); border-color: var(--danger); }

        /* REGULAR INPUTS */
        .input-grid-profile { display: grid; grid-template-columns: 0.5fr 1.5fr 0.5fr 0.8fr 1.5fr; gap: 10px; margin-bottom: 15px; }
        .form-group { margin-bottom: 0; width: 100%; }
        .std-label { display: block; font-size: 11px; font-weight: 600; color: var(--text-sec); margin-bottom: 5px; }
        .std-input { width: 100%; padding: 10px; border: 1px solid #D1D1D6; border-radius: 10px; font-size: 13px; font-weight: 500; background: #fff; }

        /* GRID LAYOUTS */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* TOGGLES */
        .ios-list { display: flex; flex-direction: column; }
        .ios-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F2F2F7; }
        .ios-item:last-child { border-bottom: none; }
        .ios-label { font-size: 14px; font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 42px; height: 26px; } 
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* METABOLIC DASHBOARD */
        .metabolic-screen-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px; margin-bottom: 25px; }
        .meta-card { background: #fff; border: 1px solid #E5E5EB; border-radius: 14px; padding: 15px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .meta-label { font-size: 10px; text-transform: uppercase; color: #86868B; font-weight: 700; margin-bottom: 4px; }
        .meta-val { font-size: 22px; font-weight: 800; color: #1D1D1F; line-height: 1.1; }
        .meta-card.surplus { background: var(--warning-dim); border-color: var(--warning); color: #d97706; }
        .meta-card.deficit { background: var(--success-dim); border-color: var(--success); color: #059669; }

        /* VISUAL BARS */
        .visual-row { margin-bottom: 20px; }
        .visual-header { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
        .bar-complex { position: relative; height: 12px; border-radius: 6px; overflow: hidden; display: flex; width: 100%; background: #E5E5EA; }
        .bar-seg { height: 100%; border-right: 1px solid rgba(255,255,255,0.4); }
        .bar-marker-wrapper { position: relative; height: 0; width: 100%; top: -16px; }
        .bar-marker { position: absolute; width: 4px; height: 20px; background: #333; border: 2px solid #fff; border-radius: 4px; transform: translateX(-50%); box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 10; transition: left 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* CPG BOXES */
        .dm-rec-box { background: #F0F7FF; border: 1px solid #CCE0FF; padding:18px; border-radius:12px; margin-bottom:20px; border-left: 5px solid var(--primary); }
        .dm-status { font-size:15px; font-weight:800; color:var(--primary); margin-bottom:8px; display:block;}
        .dm-alert { color:#B91C1C; font-weight:600; font-size:12px; display:block; margin-top:8px; background:#FEF2F2; padding:8px; border-radius:6px; border:1px solid #FECACA; }

        /* PROTEIN & EXERCISE */
        .protein-box { background: #fff; border: 1px solid #E5E5EA; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .food-calc-row { display: grid; grid-template-columns: 2fr 1fr 0.5fr; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; align-items: end; }
        .food-list { margin-top: 10px; font-size: 13px; }
        .food-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee; }

        /* ACTION BAR */
        .action-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 12px 24px; border-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; gap: 12px; border: 1px solid rgba(0,0,0,0.1); z-index: 9999; }
        .btn { border: none; padding: 10px 24px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn:hover { transform: scale(1.02); }
        .btn-p { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .btn-s { background: transparent; border: 1px solid #D1D1D6; color: var(--text); }
        .btn-ai { background: linear-gradient(135deg, #AF52DE 0%, #5856D6 100%); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(88,86,214,0.3); }

        /* MODALS */
        #keyModal, #guideModal, #defModal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .key-box { background:white; padding:30px; border-radius:24px; width:90%; max-width:420px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

        /* --- PRINT STYLES (THE GOLD STANDARD) --- */
        #clinical-report { display: none; }
        
        @media print {
            body { background: white; margin: 0; padding: 0; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container, .action-bar, #login-screen, .nav-tabs { display: none !important; }
            
            #clinical-report { display: block !important; width: 100%; max-width: 800px; margin: 0 auto; padding: 20px; }
            
            /* HEADER */
            .rpt-head { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
            .rpt-title h1 { font-size: 24pt; margin: 0; font-weight: 800; color: #000; text-transform: uppercase; letter-spacing: -1px; }
            .rpt-title span { font-size: 12pt; font-weight: 500; color: #555; }
            .rpt-meta { text-align: right; font-size: 9pt; color: #555; line-height: 1.4; }

            /* SECTION HEADERS */
            .rpt-sec { font-size: 10pt; font-weight: 800; text-transform: uppercase; color: #000; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }

            /* ROUNDED PANELS FOR PRINT DATA */
            .rpt-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .rpt-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
            
            .rpt-panel { 
                border: 1px solid #ccc; border-radius: 8px; padding: 8px 10px; background: #fff;
                break-inside: avoid; page-break-inside: avoid;
            }
            .rpt-label { display: block; font-size: 7pt; text-transform: uppercase; color: #666; font-weight: 700; margin-bottom: 2px; }
            .rpt-val { display: block; font-size: 11pt; font-weight: 700; color: #000; }

            /* HIDE ELEMENTS BASED ON CONTEXT */
            .print-hidden { display: none !important; }
            
            /* CPG BOX PRINT */
            .dm-rec-box { border: 1px solid #000; background: #F2F8FF !important; padding: 15px; border-radius: 8px; margin-top: 15px; }
            
            /* FOOTER */
            .rpt-foot { position: fixed; bottom: 10mm; left: 0; right: 0; border-top: 1px solid #eee; padding-top: 10px; font-size: 8pt; color: #999; text-align: center; }
        }
    </style>
</head>
<body>

    <div id="guideModal" class="hidden">
        <div class="key-box">
            <h3>Meal Portion Guide</h3>
            <p><strong>Small (300-350kc):</strong> Half fist Carb + Palm Protein</p>
            <p><strong>Medium (450-550kc):</strong> 1 Fist Carb + Palm Protein</p>
            <p><strong>Large (700+kc):</strong> 2 Fists Carb + 2 Palms Protein</p>
            <button class="btn btn-p" onclick="document.getElementById('guideModal').classList.add('hidden')" style="width:100%; margin-top:10px;">Close</button>
        </div>
    </div>
    
    <div id="defModal" class="hidden">
        <div class="key-box">
            <h3 id="defTitle"></h3><p id="defText" style="font-size:14px; line-height:1.5; color:#444;"></p>
            <button class="btn btn-p" onclick="document.getElementById('defModal').classList.add('hidden')" style="width:100%; margin-top:10px;">Close</button>
        </div>
    </div>

    <div class="container" id="app-ui">
        <header>
            <div class="brand">Ara<span>Shift</span> <span class="version-tag">v8.2</span></div>
            <div class="logout">Logout</div>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" id="btn-arashift" onclick="switchTab('arashift')">AraShift (Obesity)</button>
            <button class="tab-btn" id="btn-diabetes" onclick="switchTab('diabetes')">Diabetes Mgmt</button>
        </div>

        <div id="tab-arashift">
            <div class="main-grid">
                <div style="display:flex; flex-direction:column; gap:20px;">
                    <div class="card">
                        <h3>A. Patient Profile</h3>
                        <div class="input-grid-profile">
                            <div class="form-group"><span class="std-label">ID</span><input class="std-input" type="number" id="pId"></div>
                            <div class="form-group"><span class="std-label">Name</span><input class="std-input" type="text" id="pName"></div>
                            <div class="form-group"><span class="std-label">Age</span><input class="std-input" type="number" id="age"></div>
                            <div class="form-group"><span class="std-label">Gender</span><select class="std-input" id="gender"><option value="male">Male</option><option value="female">Female</option></select></div>
                            <div class="form-group"><span class="std-label">Activity</span><select class="std-input" id="activity"><option value="1.2">Sedentary</option><option value="1.375">Light</option><option value="1.55">Mod</option><option value="1.725">Active</option></select></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>B. Clinical Parameters</h3>
                        <div class="param-grid">
                            <div class="param-panel"><label>Height (cm)</label><input type="number" id="height"></div>
                            <div class="param-panel"><label>Weight (kg)</label><input type="number" id="weight"></div>
                            <div class="param-panel"><label>Waist (cm)</label><input type="number" id="waist"></div>
                            <div class="param-panel"><label>BMI</label><input type="number" id="bmi" readonly></div>
                        </div>
                        <div class="param-grid">
                            <div class="param-panel"><label>Visceral Fat</label><input type="number" id="vfat"></div>
                            <div class="param-panel"><label>Fat %</label><input type="number" id="fat"></div>
                            <div class="param-panel"><label>Muscle %</label><input type="number" id="muscle"></div>
                            <div class="param-panel"><label>R. HR (bpm)</label><input type="number" id="rhr"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;"><h3>C. Dietary Matrix</h3><button class="version-tag" onclick="document.getElementById('guideModal').classList.remove('hidden')">Size Guide</button></div>
                        <div class="meal-row"><span class="meal-label">Breakfast</span><select class="std-input" id="bfType"><option value="carb">Carb</option><option value="prot">Protein</option><option value="bal" selected>Balanced</option><option value="skip">Skip</option></select><select class="std-input" id="bfSize"><option value="S">Small</option><option value="M" selected>Medium</option><option value="L">Large</option></select></div>
                        <div class="meal-row"><span class="meal-label">Lunch</span><select class="std-input" id="luType"><option value="carb" selected>Carb</option><option value="prot">Protein</option><option value="bal">Balanced</option></select><select class="std-input" id="luSize"><option value="S">Small</option><option value="M" selected>Medium</option><option value="L">Large</option></select></div>
                        <div class="meal-row"><span class="meal-label">Dinner</span><select class="std-input" id="dnType"><option value="carb">Carb</option><option value="prot">Protein</option><option value="bal" selected>Balanced</option></select><select class="std-input" id="dnSize"><option value="S">Small</option><option value="M" selected>Medium</option><option value="L">Large</option></select></div>
                    </div>
                </div>

                <div class="card" id="resultCard">
                    <h3>D. Analysis & Strategy</h3>
                    <div class="metabolic-screen-row">
                        <div class="meta-card"><span class="meta-label">Intake</span><span class="meta-val" id="sIntake">0</span></div>
                        <div class="meta-card"><span class="meta-label">TDEE</span><span class="meta-val" id="sTDEE">0</span></div>
                        <div class="meta-card" id="sBalCard"><span class="meta-label">Balance</span><span class="meta-val" id="sBal">0</span></div>
                    </div>
                    <div id="sAnalysis"></div>
                    <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                    <div id="sRxCard"></div>
                    <div id="proteinBox" class="protein-box">
                         <div class="protein-head">Protein Recommendation</div><div id="proteinText"></div>
                         <div class="food-calc-row"><select class="std-input" id="foodType"><option value="165|31">Chicken (100g)</option><option value="78|6">Egg (1)</option></select><input class="std-input" type="number" id="foodQty" value="1"><button class="btn btn-p" onclick="addFood()">Add</button></div>
                         <div class="food-list" id="foodList"></div>
                    </div>
                    <div class="planner-box" id="exPlanner">
                        <div class="planner-header"><h4>Exercise Planner</h4><span id="totalBurn">0 kcal</span></div>
                         <div class="add-row"><select class="std-input" id="exType" onchange="updateMoves()"><option value="cardio">Cardio</option><option value="resist">Resistance</option></select><select class="std-input" id="exMove"></select><input class="std-input" type="number" id="exDur" placeholder="Min" value="30"><button class="btn btn-p" onclick="addExercise()">+</button></div>
                         <table class="plan-table"><tbody id="planBody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-diabetes" class="hidden">
            <div class="main-grid">
                <div style="display:flex; flex-direction:column; gap:20px;">
                    <div class="card">
                        <h3>A. Patient Profile (DM)</h3>
                        <div class="input-grid-profile">
                             <div class="form-group"><span class="std-label">ID</span><input class="std-input" type="number" id="dm_pId"></div>
                             <div class="form-group"><span class="std-label">Name</span><input class="std-input" type="text" id="dm_pName"></div>
                             <div class="form-group"><span class="std-label">Age</span><input class="std-input" type="number" id="dm_age"></div>
                             <div class="form-group"><span class="std-label">Gender</span><select class="std-input" id="dm_gender"><option value="male">Male</option><option value="female">Female</option></select></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>B. Clinical Parameters (DM)</h3>
                        <div class="param-grid">
                            <div class="param-panel"><label>Weight</label><input type="number" id="dm_weight"></div>
                            <div class="param-panel"><label>BMI</label><input type="number" id="dm_bmi" readonly></div>
                            <div class="param-panel"><label>BP Sys</label><input type="number" id="dm_sbp"></div>
                            <div class="param-panel"><label>BP Dia</label><input type="number" id="dm_dbp"></div>
                        </div>
                        <span class="sub-label">Biochemistry</span>
                        <div class="param-grid">
                            <div class="param-panel"><label>FBS <span class="help-icon" onclick="showDef('fbs')">?</span></label><input type="number" id="dm_fbs" step="0.1"></div>
                            <div class="param-panel"><label>HbA1c <span class="help-icon" onclick="showDef('hba1c')">?</span></label><input type="number" id="dm_hba1c" step="0.1"></div>
                            <div class="param-panel"><label>LDL <span class="help-icon" onclick="showDef('ldl')">?</span></label><input type="number" id="dm_ldl" step="0.1"></div>
                            <div class="param-panel"><label>eGFR <span class="help-icon" onclick="showDef('egfr')">?</span></label><input type="number" id="dm_egfr"></div>
                        </div>
                        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                            <label style="margin-bottom:8px;">Comorbidities (CVOT Flags)</label>
                            <div class="ios-list">
                                <div class="ios-item"><span class="ios-label">ASCVD / High CV Risk</span><label class="switch"><input type="checkbox" id="dm_ascvd"><span class="slider round"></span></label></div>
                                <div class="ios-item"><span class="ios-label">DKD (Renal Disease)</span><label class="switch"><input type="checkbox" id="dm_dkd"><span class="slider round"></span></label></div>
                                <div class="ios-item"><span class="ios-label">Heart Failure</span><label class="switch"><input type="checkbox" id="dm_hf"><span class="slider round"></span></label></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                     <h3>CPG Recommendations</h3>
                     <div class="dm-rec-box">
                        <span class="dm-status" id="dmStatus">Status: Pending</span>
                        <div id="dmRecText" style="font-size:13px; line-height:1.5;">Enter HbA1c to generate plan.</div>
                        <div id="dmAlerts"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button class="btn btn-s" onclick="location.reload()">Reset</button>
        <button class="btn btn-p" onclick="runCalc(); runDMCalc();">Analyze</button>
        <button class="btn btn-s" onclick="doPrint()">üñ®Ô∏è Print Report</button>
    </div>

    <div id="clinical-report">
        <div class="rpt-head">
            <div class="rpt-title"><h1 id="printTitle">AraShift Report</h1><span id="printSubtitle">Metabolic Assessment</span></div>
            <div class="rpt-meta">Date: <span id="pdDate"></span><br>ID: <span id="pdId"></span></div>
        </div>
        
        <div class="rpt-sec">A. Patient Profile</div>
        <div class="rpt-grid-4">
            <div class="rpt-panel"><span class="rpt-label">Name</span><span class="rpt-val" id="pdName"></span></div>
            <div class="rpt-panel"><span class="rpt-label">Age/Sex</span><span class="rpt-val" id="pdDemo"></span></div>
            <div class="rpt-panel"><span class="rpt-label">Activity</span><span class="rpt-val" id="pdActivity"></span></div>
        </div>

        <div class="rpt-sec">B. Clinical Parameters</div>
        <div class="rpt-grid-4" style="margin-bottom:10px;">
            <div class="rpt-panel"><span class="rpt-label">Ht / Wt</span><span class="rpt-val" id="pdBio"></span></div>
            <div class="rpt-panel"><span class="rpt-label">BMI</span><span class="rpt-val" id="pdBMI"></span></div>
            <div class="rpt-panel"><span class="rpt-label">Waist</span><span class="rpt-val" id="pdWaist"></span></div>
            <div class="rpt-panel"><span class="rpt-label">Visceral Fat</span><span class="rpt-val" id="pdVFat"></span></div>
        </div>
        <div class="rpt-grid-4">
            <div class="rpt-panel"><span class="rpt-label">BP</span><span class="rpt-val" id="pdBP"></span></div>
            <div class="rpt-panel"><span class="rpt-label">Glucose (F/A1c)</span><span class="rpt-val" id="pdGluc"></span></div>
            <div class="rpt-panel"><span class="rpt-label">Lipids (L/H)</span><span class="rpt-val" id="pdLipid"></span></div>
            <div class="rpt-panel"><span class="rpt-label">eGFR</span><span class="rpt-val" id="pdGFR"></span></div>
        </div>

        <div id="print-obesity-content">
            <div class="rpt-sec">C. Analysis</div>
            <div class="metabolic-row">
                <div class="print-stat-card"><span class="p-stat-label">Intake</span><span class="p-stat-val" id="pdIntake"></span></div>
                <div class="print-stat-card"><span class="p-stat-label">TDEE</span><span class="p-stat-val" id="pdTDEE"></span></div>
                <div class="print-stat-card"><span class="p-stat-label">Balance</span><span class="p-stat-val" id="pdBal"></span></div>
            </div>
            <div id="pdVisuals"></div>
            <div class="rpt-sec">D. Strategy</div>
            <div id="pdProtein"></div>
            <div id="pdRx"></div>
            <div id="pdRxContainer"></div>
        </div>

        <div id="print-diabetes-content" class="print-hidden">
             <div class="rpt-sec">C. CPG Management Plan</div>
             <div class="dm-rec-box">
                 <span class="dm-status" id="pdDmStatus"></span>
                 <div id="pdDmRec" style="font-size:11pt; line-height:1.4;"></div>
                 <div id="pdDmAlert" style="margin-top:10px; font-weight:bold; color:#B91C1C;"></div>
             </div>
        </div>

        <div class="rpt-foot">Generated by AraShift Medical Suite v8.2</div>
    </div>

    <script>
        // GLOBALS
        let currentTab = 'arashift';
        const calMap = { 'carb': {'S':300,'M':500,'L':800}, 'prot': {'S':250,'M':450,'L':700}, 'bal': {'S':350,'M':550,'L':750}, 'lite': {'S':150,'M':250,'L':350}, 'skip': {'S':0,'M':0,'L':0} };
        const moves = { 'cardio': [{name:"Walk", met:3.5}, {name:"Run", met:8.0}], 'resist': [{name:"Weights", met:6.0}] };
        let plan = [], foodPlan = [];

        // UI LOGIC
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            
            if(tab === 'arashift') {
                document.getElementById('tab-arashift').classList.remove('hidden');
                document.getElementById('tab-diabetes').classList.add('hidden');
            } else {
                document.getElementById('tab-arashift').classList.add('hidden');
                document.getElementById('tab-diabetes').classList.remove('hidden');
            }
        }

        function showDef(id) {
            const defs = {
                "id": "Medical ID for tracking.", "act": "Multiplier for TDEE.", "bmi": "Wt/Ht¬≤. >23 is Overweight (Asian).", 
                "fbs": "Fasting Glucose. Normal <5.6.", "hba1c": "3-mo Avg Glucose. DM ‚â•6.3%.", "egfr": "Kidney function. <60 is CKD."
            };
            document.getElementById('defTitle').innerText = id.toUpperCase();
            document.getElementById('defText').innerText = defs[id] || "Clinical Parameter.";
            document.getElementById('defModal').classList.remove('hidden');
        }

        // CALCULATION LOGIC
        function runCalc() {
            // OBESITY LOGIC
            let w = parseFloat(document.getElementById('weight').value) || 0;
            let h = parseFloat(document.getElementById('height').value) || 0;
            let bmi = (w/((h/100)*(h/100))).toFixed(1);
            if(w>0 && h>0) document.getElementById('bmi').value = bmi;

            // Simplified Metabolic
            let intake = 0; // Simplified for demo
            let tdee = w * 25 * parseFloat(document.getElementById('activity').value);
            document.getElementById('sTDEE').innerText = Math.round(tdee);
            
            // Visuals
            let vHTML = getDetailedBar("BMI", bmi, "", 40, [{limit:23,color:"#34C759"},{limit:27.5,color:"#FF9500"},{limit:40,color:"#FF3B30"}]);
            document.getElementById('sAnalysis').innerHTML = vHTML;
            document.getElementById('pdVisuals').innerHTML = vHTML;
            
            // Protein
            document.getElementById('proteinText').innerText = w > 0 ? `Target: ${Math.round(w*1.2)}-${Math.round(w*1.5)}g` : "Enter Weight";
            
            // Exercise Rx
            document.getElementById('sRxCard').innerHTML = `<div class="rx-box" style="padding:15px"><b>Rx:</b> ${bmi>35?"Low Impact":"Standard"} Protocol</div>`;
            document.getElementById('pdRx').innerHTML = document.getElementById('sRxCard').innerHTML;
        }

        function runDMCalc() {
            let a1c = parseFloat(document.getElementById('dm_hba1c').value);
            let status = a1c >= 6.3 ? "Diabetes" : (a1c >= 5.7 ? "Pre-Diabetes" : "Normal");
            let rec = "";
            
            if(status === "Diabetes") {
                if(a1c < 7.5) rec = "Monotherapy (Metformin)";
                else if(a1c < 8.5) rec = "Dual Therapy (Met + SGLT2i/DPP4i)";
                else rec = "Triple Therapy / Insulin";
            }
            if(document.getElementById('dm_dkd').checked) rec += "<br>+ SGLT2i (Renal Protect)";
            
            document.getElementById('dmStatus').innerText = status;
            document.getElementById('dmRecText').innerHTML = rec;
            
            // Sync to Print vars
            document.getElementById('pdDmStatus').innerText = status;
            document.getElementById('pdDmRec').innerHTML = rec;
        }

        // PRINT LOGIC (THE MAGIC)
        function doPrint() {
            // 1. Map Shared Bio Data based on Active Tab
            let p = currentTab === 'arashift' ? '' : 'dm_';
            
            document.getElementById('pdName').innerText = document.getElementById(p+'pName').value;
            document.getElementById('pdId').innerText = document.getElementById(p+'pId').value;
            document.getElementById('pdBio').innerText = `${document.getElementById(p+'height').value}cm / ${document.getElementById(p+'weight').value}kg`;
            document.getElementById('pdBMI').innerText = document.getElementById(p+'bmi').value;
            document.getElementById('pdWaist').innerText = document.getElementById(p+'waist').value;
            
            // 2. Map DM Specifics if DM Tab
            if(currentTab === 'diabetes') {
                document.getElementById('pdGluc').innerText = `F:${document.getElementById('dm_fbs').value} / A1c:${document.getElementById('dm_hba1c').value}%`;
                document.getElementById('pdBP').innerText = `${document.getElementById('dm_sbp').value}/${document.getElementById('dm_dbp').value}`;
                document.getElementById('pdGFR').innerText = document.getElementById('dm_egfr').value;
                
                document.getElementById('printTitle').innerText = "Diabetes Management Report";
                document.getElementById('printSubtitle').innerText = "CPG Assessment";
                document.getElementById('print-obesity-content').classList.add('print-hidden');
                document.getElementById('print-diabetes-content').classList.remove('print-hidden');
            } else {
                // Map Obesity Specifics
                document.getElementById('pdVFat').innerText = document.getElementById('vfat').value;
                document.getElementById('pdBP').innerText = `${document.getElementById('sbp').value}/${document.getElementById('dbp').value}`;
                
                document.getElementById('printTitle').innerText = "AraShift Report";
                document.getElementById('printSubtitle').innerText = "Metabolic Assessment";
                document.getElementById('print-obesity-content').classList.remove('print-hidden');
                document.getElementById('print-diabetes-content').classList.add('print-hidden');
                
                // Clone Planner for print
                document.getElementById('pdProtein').innerHTML = document.getElementById('proteinBox').innerHTML.replace(/<div class="food-calc-row">[\s\S]*?<\/div>/, "");
                document.getElementById('pdRxContainer').innerHTML = document.getElementById('exPlanner').innerHTML;
            }

            document.getElementById('pdDate').innerText = new Date().toLocaleDateString();
            window.print();
        }

        // HELPERS
        function updateMoves(){
            let s = document.getElementById('exMove'); s.innerHTML="";
            moves[document.getElementById('exType').value].forEach(m=>{let o=document.createElement('option');o.text=m.name;s.add(o)});
        }
        function addFood() {
             let f=document.getElementById('foodList'); f.innerHTML += `<div class="food-item"><span>${document.getElementById('foodType').options[document.getElementById('foodType').selectedIndex].text}</span></div>`;
        }
        function addExercise() {
             let t=document.getElementById('planBody'); t.innerHTML += `<tr><td>${document.getElementById('exMove').options[document.getElementById('exMove').selectedIndex].text}</td><td>${document.getElementById('exDur').value}m</td></tr>`;
        }
        function getDetailedBar(l,v,u,m,s) {
            let h=""; s.forEach(i=>{h+=`<div class="bar-seg" style="width:${(i.limit/m)*100}%;background:${i.color}"></div>`});
            return `<div class="visual-row"><div class="visual-header"><span>${l}</span><span>${v}</span></div><div class="bar-complex">${h}<div class="bar-marker" style="left:${(v/m)*100}%"></div></div></div>`;
        }

        // INIT
        window.onload = () => { updateMoves(); };
    </script>
</body>
</html>
